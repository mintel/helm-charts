{{- range .Values.cronjobs.jobs }}
---
{{- $data := dict "Release" $.Release "Chart" $.Chart "Values" $.Values "component" .name }}
apiVersion: {{ include "common.capabilities.cronjob.apiVersion" $ }}
kind: CronJob
metadata:
  name: {{ include "mintel_common.fullname" $data }}
  labels: {{ include "mintel_common.labels" $data | nindent 4 }}
  annotations: {{ include "mintel_common.commonAnnotations" $ | nindent 4 }}
  namespace: {{ $.Release.Namespace }}
spec:
  concurrencyPolicy: {{ coalesce .concurrencyPolocy $.Values.cronjobs.defaults.concurrencyPolicy }}
  {{- if (coalesce .suspend $.Values.cronjobs.defaults.suspend) }}
  suspend: true
  {{- else }}
  suspend: false
  {{- end }}
  schedule: {{ .schedule }}
  jobTemplate:
    spec:
      template:
        metadata:
          labels: {{ include "mintel_common.labels" $data | nindent 12 }}
        spec:
          {{- include "mintel_common.imagePullSecrets" $ | nindent 10 }}
          {{- with .podSecurityContext }}
          securityContext: {{ toYaml . | nindent 12 }}
          {{- end }}
          {{- if (and $.Values.serviceAccount (or $.Values.serviceAccount.create $.Values.serviceAccount.name)) }}
          serviceAccountName: {{ default (include "mintel_common.fullname" $) $.Values.serviceAccount.name }}
          {{- end }}
          restartPolicy: {{ coalesce .restartPolicy $.Values.cronjobs.defaults.restartPolicy }}
          {{- with .extraInitContainers }}
          initContainers:
          {{- toYaml . | nindent 12 }}
          {{- end }}
          containers:
            - name: main
              image: {{ coalesce .image (include "mintel_common.image" $) }}
              imagePullPolicy: {{ include "mintel_common.imagePullPolicy" $ }}
              {{- with .command }}
              command: {{ toYaml . | nindent 16 }}
              {{- end }}
              {{- with .args }}
              args:
                {{- range $key, $value := . }}
                {{- if $value }}
                - {{ $key }}-{{ $value }}
                {{- else }}
                - {{ $key }}
                {{- end }}
                {{- end }}
              {{- end }}
              env:
                - name: KUBERNETES_POD_NAMESPACE
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.namespace
                {{- include "mintel_common.localDevEnv" $ | nindent 16 }}
                {{- include "mintel_common.defaultEnv" $ | nindent 16 }}
                {{- include "mintel_common.mailhogEnv" $ | nindent 16 }}
                {{- include "mintel_common.redisEnv" $ | nindent 16 }}
                {{- include "mintel_common.elasticsearchEnv" $ | nindent 16 }}
                {{- include "mintel_common.opensearchEnv" $ | nindent 16 }}
                {{- include "mintel_common.localstackEnv" $ | nindent 16 }}
                {{- with $.Values.env }}
                {{- toYaml . | nindent 16 }}
                {{- end }}
                {{- with .env }}
                {{- toYaml . | nindent 16 }}
                {{- end }}
              envFrom:
                {{- if (and $.Values.externalSecret $.Values.externalSecret.enabled) }}
                {{- if (or (ne $.Values.global.clusterEnv "local") (and (eq $.Values.global.clusterEnv "local") $.Values.externalSecret.localValues)) }}
                - secretRef:
                    name: {{ default (include "mintel_common.defaultAppSecretName" $) $.Values.externalSecret.nameOverride }}
                {{- end }}
                {{- end }}
                {{- if (and $.Values.mariadb $.Values.mariadb.enabled) }}
                - secretRef:
                    name: {{ default (include "mintel_common.defaultMariadbSecretName" $) $.Values.mariadb.secretNameOverride }}
                {{- end }}
                {{- if (and $.Values.postgresql $.Values.postgresql.enabled) }}
                - secretRef:
                    name: {{ default (include "mintel_common.defaultPostgresqlSecretName" $) $.Values.postgresql.secretNameOverride }}
                {{- end }}
                {{- if (and $.Values.redis $.Values.redis.enabled) }}
                - secretRef:
                    name: {{ default (include "mintel_common.defaultRedisSecretName" $) $.Values.redis.secretNameOverride }}
                {{- end }}
                {{- if (and $.Values.elasticsearch $.Values.elasticsearch.enabled) }}
                - secretRef:
                    name: {{ default (include "mintel_common.defaultElasticsearchSecretName" $) $.Values.elasticsearch.secretNameOverride }}
                {{- end }}
                {{- if (and $.Values.opensearch $.Values.opensearch.enabled) }}
                - secretRef:
                    name: {{ default (include "mintel_common.defaultOpensearchSecretName" $) $.Values.opensearch.secretNameOverride }}
                {{- end }}
                {{- with $.Values.envFrom }}
                {{- toYaml . | nindent 16 }}
                {{- end }}
                {{- with .envFrom }}
                {{- toYaml . | nindent 16 }}
                {{- end }}
              {{- with .resources }}
              resources: {{- toYaml . | nindent 16 }}
              {{- end }}

{{- end }}
