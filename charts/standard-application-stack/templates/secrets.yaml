{{- if (and .Values.externalSecret .Values.externalSecret.enabled) }}
{{- if (eq .Values.global.clusterEnv "local") }}
{{- if .Values.externalSecret.localValues }}
---
apiVersion: {{ include "common.capabilities.secret.apiVersion" . }}
kind: Secret
metadata:
  name: {{ include "mintel_common.fullname" . }}-app
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  annotations: {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  {{- range (required ".externalSecret.localValues required for local env" .Values.externalSecret.localValues) }}
  {{ .name }}: {{ .value | b64enc }}
  {{- end }}
{{- end }}
{{- else }}
---
apiVersion: {{ include "common.capabilities.externalsecret.apiVersion" . }}
kind: ExternalSecret
metadata:
  name: {{ include "mintel_common.fullname" . }}-app
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
  annotations:
    {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  backendType: {{ default $.Values.externalSecret.backendType "secretsManager" }}
  dataFrom:
    - {{ coalesce .Values.externalSecret.pathOverride (printf "%s/%s/app" (.Release.Namespace) (include "mintel_common.fullname" .)) }}
{{- end }}
{{- end }}


{{- range .Values.extraSecrets }}
{{- $secretData := dict "Release" $.Release "Chart" $.Chart "Values" $.Values "component" .name }}
{{- if (eq $.Values.global.clusterEnv "local") }}
---
apiVersion: {{ include "common.capabilities.secret.apiVersion" $ }}
kind: Secret
metadata:
  name: {{ include "mintel_common.fullname" $secretData }}
  labels: {{ include "mintel_common.labels" $secretData | nindent 4 }}
  annotations: {{ include "mintel_common.commonAnnotations" $ | nindent 4 }}
  namespace: {{ $.Release.Namespace }}
type: Opaque
data:
  {{- range (required ".localValues required for local env" .localValues) }}
  {{ .name }}: {{ .value | b64enc }}
  {{- end }}
{{- else }}
---
apiVersion: {{ include "common.capabilities.externalsecret.apiVersion" $ }}
kind: ExternalSecret
metadata:
  name: {{ include "mintel_common.fullname" $secretData }}
  labels: {{ include "mintel_common.labels" $secretData | nindent 4 }}
  namespace: {{ $.Release.Namespace }}
  annotations:
    {{ include "mintel_common.commonAnnotations" $ | nindent 4 }}
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  backendType: {{ default .backendType "secretsManager" }}
  dataFrom:
    - {{ coalesce .path (printf "%s/%s/%s" $.Release.Namespace (include "mintel_common.fullname" $) .name) }}
{{- end }}
{{- end }}

{{- if (and .Values.mariadb .Values.mariadb.enabled) }}
{{- if (ne .Values.global.clusterEnv "local") }}
---
apiVersion: {{ include "common.capabilities.externalsecret.apiVersion" . }}
kind: ExternalSecret
metadata:
  name: {{ include "mintel_common.fullname" . }}-mariadb
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
  annotations:
    {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  backendType: {{ default $.Values.externalSecret.backendType "secretsManager" }}
  data:
    {{- $dataKey := ( coalesce .Values.mariadb.secretPathOverride (printf "%s/%s/mariadb" (.Release.Namespace) (include "mintel_common.fullname" .))) }}
    - key: {{ $dataKey }}
      name: DB_HOST
      property: host
    - key: {{ $dataKey }}
      name: DB_NAME
      property: dbname
    - key: {{ $dataKey }}
      name: DB_USER
      property: username
    - key: {{ $dataKey }}
      name: DB_PASSWORD
      property: password
{{- else }}
---
apiVersion: {{ include "common.capabilities.secret.apiVersion" . }}
kind: Secret
metadata:
  name: {{ include "mintel_common.fullname" . }}-mariadb
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  annotations: {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  DB_HOST: {{ printf "%s-mariadb" (include "mintel_common.fullname" .) | b64enc }}
  DB_NAME: {{ .Values.mariadb.auth.database | b64enc }}
  DB_USER: {{ .Values.mariadb.auth.username | b64enc }}
  DB_PASSWORD: {{ .Values.mariadb.auth.password | b64enc }}
  mariadb-root-password: {{ .Values.mariadb.auth.password | b64enc }}
  mariadb-password: {{ .Values.mariadb.auth.password | b64enc }}
{{- end }}
{{- end }}

{{- if (and .Values.redis .Values.redis.enabled) }}
{{- if (ne .Values.global.clusterEnv "local") }}
---
apiVersion: {{ include "common.capabilities.externalsecret.apiVersion" . }}
kind: ExternalSecret
metadata:
  name: {{ include "mintel_common.fullname" . }}-redis
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
  annotations:
    {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  backendType: {{ default $.Values.externalSecret.backendType "secretsManager" }}
  dataFrom:
    - {{ coalesce .Values.redis.secretPathOverride (printf "%s/%s/redis" (.Release.Namespace) (include "mintel_common.fullname" .)) }}
{{- else }}
---
apiVersion: {{ include "common.capabilities.secret.apiVersion" . }}
kind: Secret
metadata:
  name: {{ include "mintel_common.fullname" . }}-redis
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  annotations: {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  REDIS_PRIMARY_ENDPOINT: {{ printf "%s-redis-headless:6379" (include "mintel_common.fullname" .) | b64enc }}
  REDIS_AUTH_TOKEN: {{ (default "test" .Values.redis.auth.password) | b64enc }}
{{- end }}
{{- end }}

{{- if (and .Values.elasticsearch .Values.elasticsearch.enabled) }}
{{- if (ne .Values.global.clusterEnv "local") }}
---
apiVersion: {{ include "common.capabilities.externalsecret.apiVersion" . }}
kind: ExternalSecret
metadata:
  name: {{ include "mintel_common.fullname" . }}-elasticsearch
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
  annotations:
    {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  backendType: {{ default $.Values.externalSecret.backendType "secretsManager" }}
  dataFrom:
    - {{ coalesce .Values.elasticsearch.secretPathOverride (printf "%s/%s/elasticsearch" (.Release.Namespace) (include "mintel_common.fullname" .)) }}
  data:
    {{- $dataKey := ( coalesce .Values.elasticsearch.secretPathOverride (printf "%s/%s/elasticsearch" (.Release.Namespace) (include "mintel_common.fullname" .))) }}
    - key: {{ $dataKey }}
      name: ES_HOSTS
      property: ELASTICSEARCH_HOST
{{- else }}
---
apiVersion: {{ include "common.capabilities.secret.apiVersion" . }}
kind: Secret
metadata:
  name: {{ include "mintel_common.fullname" . }}-elasticsearch
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  annotations: {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  ELASTICSEARCH_HOST: {{ printf "%s-elasticsearch-master-headless" (include "mintel_common.fullname" .) | b64enc }}
  ES_HOSTS: {{ printf "%s-elasticsearch-master-headless" (include "mintel_common.fullname" .) | b64enc }}
{{- end }}
{{- end }}

{{- if (and .Values.opensearch .Values.opensearch.enabled) }}
{{- if (ne .Values.global.clusterEnv "local") }}
---
apiVersion: {{ include "common.capabilities.externalsecret.apiVersion" . }}
kind: ExternalSecret
metadata:
  name: {{ include "mintel_common.fullname" . }}-opensearch
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
  annotations:
    {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  backendType: {{ default $.Values.externalSecret.backendType "secretsManager" }}
  dataFrom:
    - {{ coalesce .Values.opensearch.secretPathOverride (printf "%s/%s/opensearch" (.Release.Namespace) (include "mintel_common.fullname" .)) }}
  data:
    {{- $dataKey := ( coalesce .Values.opensearch.secretPathOverride (printf "%s/%s/opensearch" (.Release.Namespace) (include "mintel_common.fullname" .))) }}
    {{- if (not .Values.opensearch.awsEsProxy.enabled) }}
    - key: {{ $dataKey }}
      name: ES_HOSTS
      property: OPENSEARCH_HOST
    {{- end }}
    - key: {{ $dataKey }}
      name: ELASTICSEARCH_HOST
      property: OPENSEARCH_HOST
{{- else }}
---
apiVersion: {{ include "common.capabilities.secret.apiVersion" . }}
kind: Secret
metadata:
  name: {{ include "mintel_common.fullname" . }}-opensearch
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  annotations: {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  ELASTICSEARCH_HOST: {{ printf "http://opensearch-cluster-master-headless:5601" | b64enc }}
  {{- if (not .Values.opensearch.awsEsProxy.enabled) }}
  ES_HOSTS: {{ printf "http://opensearch-cluster-master-headless:5601" | b64enc }}
  {{- end }}
  OPENSEARCH_HOST: {{ printf "http://opensearch-cluster-master-headless:5601" | b64enc }}
  OPENSEARCH_DASHBOARD_HOST: {{ printf "%s-opensearch-dashboards" (include "mintel_common.fullname" .) | b64enc }}
{{- end }}
{{- end }}

{{- if (and .Values.postgresql .Values.postgresql.enabled) }}
{{- if (ne .Values.global.clusterEnv "local") }}
---
apiVersion: {{ include "common.capabilities.externalsecret.apiVersion" . }}
kind: ExternalSecret
metadata:
  name: {{ include "mintel_common.fullname" . }}-postgresql
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
  annotations:
    {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  backendType: {{ default $.Values.externalSecret.backendType "secretsManager" }}
  data:
    {{- $dataKey := ( coalesce .Values.postgresql.secretPathOverride (printf "%s/%s/postgres" (.Release.Namespace) (include "mintel_common.fullname" .))) }}
    - key: {{ $dataKey }}
      name: DB_HOST
      property: host
    - key: {{ $dataKey }}
      name: DB_NAME
      property: dbname
    - key: {{ $dataKey }}
      name: DB_USER
      property: username
    - key: {{ $dataKey }}
      name: DB_PASSWORD
      property: password
{{- else }}
---
apiVersion: {{ include "common.capabilities.secret.apiVersion" . }}
kind: Secret
metadata:
  name: {{ include "mintel_common.fullname" . }}-postgresql
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  annotations: {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  DB_HOST: {{ printf "%s-postgresql" (include "mintel_common.fullname" .) | b64enc }}
  DB_NAME: {{ .Values.postgresql.auth.database | b64enc }}
  DB_USER: {{ .Values.postgresql.auth.username | b64enc }}
  DB_PASSWORD: {{ .Values.postgresql.auth.password | b64enc }}
  postgresql-postgres-password: {{ .Values.postgresql.auth.password | b64enc }}
  postgresql-password: {{ .Values.postgresql.auth.password | b64enc }}
{{- end }}
{{- end }}

{{- if (and .Values.oauthProxy .Values.oauthProxy.enabled) }}
{{- if (ne .Values.global.clusterEnv "local") }}
---
apiVersion: {{ include "common.capabilities.externalsecret.apiVersion" . }}
kind: ExternalSecret
metadata:
  {{- if .Values.oauthProxy.secretNameOverride }}
  name: {{ .Values.oauthProxy.secretNameOverride }}
  {{- else if .Values.oauthProxy.secretSuffix }}
  name: {{ printf "%s-%s" (include "mintel_common.fullname" .) .Values.oauthProxy.secretSuffix }}
  {{- else }}
  name: {{ printf "%s-oauth" (include "mintel_common.fullname" .) }}
  {{- end }}
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
  annotations:
    {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  backendType: {{ default $.Values.externalSecret.backendType "secretsManager" }}
  dataFrom:
    - {{ coalesce .Values.oauthProxy.secretPathOverride (printf "%s/%s/oauth" (.Release.Namespace) (include "mintel_common.fullname" .)) }}
{{- else }}
---
apiVersion: {{ include "common.capabilities.secret.apiVersion" . }}
kind: Secret
metadata:
  {{- if .Values.oauthProxy.secretNameOverride }}
  name: {{ .Values.oauthProxy.secretNameOverride }}
  {{- else if .Values.oauthProxy.secretSuffix }}
  name: {{ printf "%s-%s" (include "mintel_common.fullname" .) .Values.oauthProxy.secretSuffix }}
  {{- else }}
  name: {{ printf "%s-oauth" (include "mintel_common.fullname" .) }}
  {{- end }}
  labels: {{ include "mintel_common.labels" . | nindent 4 }}
  annotations: {{ include "mintel_common.commonAnnotations" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  {{- range (required ".Values.oauthProxy.localSecretValues required for local env" .Values.oauthProxy.localSecretValues) }}
  {{ .name }}: {{ .value | b64enc }}
  {{- end }}
{{- end }}
{{- end }}
