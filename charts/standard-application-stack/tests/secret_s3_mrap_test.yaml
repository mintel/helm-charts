suite: Test S3 Multi-Region Access Point Secret
templates:
  - deployment.yaml
release:
  namespace: test-namespace
tests:
  - it: Check S3 MRAP envfrom secretRef is present
    set:
      global.clusterEnv: qa
      global.name: test-app
      global.terraform.externalSecrets: false
      s3MultiRegionAccessPoint.enabled: true
      # Disable default application secret
      externalSecret.enabled: false
      cronjobsOnly: false
      jobsOnly: false
    asserts:
      - matchSnapshot: {} # Check for regressions and unexpected changes.
      - isKind:
          of: Deployment
      - equal:
          path: metadata.namespace
          value: test-namespace
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: test-app-s3-multi-region-access-point

  - it: Check S3 MRAP secretName Override
    set:
      global.clusterEnv: qa
      global.name: test-app
      global.terraform.externalSecrets: false
      s3MultiRegionAccessPoint.enabled: true
      s3MultiRegionAccessPoint.secretNameOverride: overrideName
      # Disable default application secret
      externalSecret.enabled: false
      cronjobsOnly: false
      jobsOnly: false
    asserts:
      - matchSnapshot: {} # Check for regressions and unexpected changes.
      - isKind:
          of: Deployment
      - equal:
          path: metadata.namespace
          value: test-namespace
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: overrideName

  - it: Check S3 MRAP envfrom secretRef is present for local environment
    set:
      global.clusterEnv: local
      global.name: test-app
      global.terraform.externalSecrets: false
      s3MultiRegionAccessPoint.enabled: true
      # Disable default application secret
      externalSecret.enabled: false
      cronjobsOnly: false
      jobsOnly: false
    asserts:
      - matchSnapshot: {} # Check for regressions and unexpected changes.
      - isKind:
          of: Deployment
      - equal:
          path: metadata.namespace
          value: test-namespace
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: test-app-s3-multi-region-access-point
