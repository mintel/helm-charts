# List the supported resource types here. These should map directly to the top-level fields of the same name in the
# values.yaml file.
{{- $global := $.Values.global }}
# check if any of the irsa dependent resources are enabled
{{- if (or $.Values.opensearch.enabled $.Values.s3.enabled $.Values.dynamodb.enabled $.Values.sns.enabled $.Values.sqs.enabled) }}
  {{- $irsaConfig := $.Values.irsa }}
  {{- $moduleSource := $irsaConfig.terraform.module.source }}
  {{- $moduleVersion := $irsaConfig.terraform.module.version }}
  {{- $tfVersion := $irsaConfig.terraform.terraformVersion }}
  {{- if not (hasKey $irsaConfig "name") }}
    {{- $_ := set $irsaConfig "name" (printf "%s-%s-%s" $global.clusterName $.Release.Namespace $global.name ) }}
  {{- end }}
  {{- if not (hasKey $irsaConfig "aws_account_name") }}
    {{- $_ := set $irsaConfig "aws_account_name" $global.clusterEnv }}
  {{ end }}
  {{- if not (hasKey $irsaConfig "aws_region") }}
    {{- $_ := set $irsaConfig "aws_region" $global.clusterRegion }}
  {{ end }}
  {{- if not (hasKey $irsaConfig "eks_cluster_name") }}
    {{- $_ := set $irsaConfig "eks_cluster_name" $global.clusterName }}
  {{ end }}
  {{- if not (hasKey $irsaConfig "tags") }}
    {{- $_ := set $irsaConfig "tags" (dict "key" "tags" "value" (printf "{\n  Owner       = \"%s\"\n  Project     = \"%s\"\n  Application = \"%s\"\n}" $global.owner $global.partOf $global.name ) "hcl" true) }}
  {{ end }}
  {{- if not (hasKey $irsaConfig "tfcloud_agent") }}
    {{- $_ := set $irsaConfig "tfcloud_agent" "true" }}
  {{ end }}
  {{- if (not (hasKey $irsaConfig "trigger")) }}
    {{- $_ := set $irsaConfig "trigger" ($.Values | toString | sha256sum) }}
  {{- end }}
  {{- if (not (hasKey $irsaConfig "k8s_service_account_name")) }}
    {{- $_ := set $irsaConfig "k8s_service_account_name" $global.name }}
  {{- end }}
  {{- if (not (hasKey $irsaConfig "k8s_namespace")) }}
    {{- $_ := set $irsaConfig "k8s_namespace" $.Release.Namespace }}
  {{- end }}
  # Create the CRD
  {{- include "mintel_common.workspace" (list $ . $irsaConfig "irsa" $moduleSource $moduleVersion $tfVersion) }}
{{- end }}
