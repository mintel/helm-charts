{{- if .Values.global.terraform.externalSecrets }}
{{- range include "mintel_common.terraformCloudResources" $ | split "," }}
  {{- $global := $.Values.global }}
  {{- $resourceType := . }}
  {{- $resourceConfig := (get $.Values .) }}
  {{- if $resourceConfig.enabled }}
    {{- range $instanceName, $instanceConfig := default ( dict "default" dict ) $resourceConfig.terraform.instances }}
      # Set name if not provided
      {{- if not ( hasKey $instanceConfig "name" ) }}
        {{- if eq $instanceName "default" }}
          {{- $_ := set $instanceConfig "name" $.Values.global.name }}
        {{- else }}
          {{- $_ := set $instanceConfig "name" $instanceName }}
        {{- end }}
      {{- end }}
      {{- if not (hasKey $instanceConfig "output_secret_name") }}
        {{- $_ := set $instanceConfig "output_secret_name" ( printf "%s/%s/%s" $.Release.Namespace $instanceConfig.name $resourceType ) }}
      {{ end }}
---
      {{- include "mintel_common.workspaceOutputSecret" (list $ . $instanceConfig $resourceType ) }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}
